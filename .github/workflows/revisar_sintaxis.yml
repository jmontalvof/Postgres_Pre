name: "üîé Revisi√≥n de Sintaxis SQL con IA"

on:
  workflow_dispatch:
  push:
    branches:
      - development
      - main
    paths:
      - 'src/*.sql'
      - 'src/scripts*.txt'

jobs:
  revisar-sintaxis:
    runs-on: ubuntu-latest
    container:
      image: jmontalvof/postgres-ia-runner:latest

    steps:
      - name: üì• Clonar repositorio
        uses: actions/checkout@v3

      - name: üìÇ Mostrar scripts disponibles
        run: ls -la src/

      - name: üìÑ Revisi√≥n sint√°ctica de scripts SQL
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for script in $(cat src/scripts_dev.txt); do
            echo "üîç Validando sintaxis: $script"
            if ! psql -f src/$script 2>error.log; then
              echo "‚ö†Ô∏è Error detectado en $script"
              ERROR_MSG=$(cat error.log | tail -n 5)
              echo "üß† Enviando a ChatGPT para correcci√≥n..."

              python fix_sql.py --error "$ERROR_MSG" --file src/$script

              if [ -f src/${script%.sql}_fix.sql ]; then
                echo "‚úÖ Script corregido: ${script%.sql}_fix.sql"
              else
                echo "‚ùå Fallo en la correcci√≥n autom√°tica."
                exit 1
              fi
            else
              echo "‚úÖ $script pas√≥ revisi√≥n sin errores"
            fi
          done

      - name: ‚úÖ Notificaci√≥n final
        run: echo "üéØ Todos los scripts est√°n listos para despliegue."
